define(['jquery.ui'], function (ui) {
    var modal = {
        sysinfo: null,
        id: 0,
        type: 1,
        navs: {},
        initnav: [],
        data: {},
        selected: 'page',
        childid: null,
        keyworderr: false,
        is_xcx: 0
    };
    jQuery.base64 = (function ($) {
        var _PADCHAR = "=", _ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/", _VERSION = "1.1";

        function _getbyte64(s, i) {
            var idx = _ALPHA.indexOf(s.charAt(i));
            if (idx === -1) {
                throw"Cannot decode base64"
            }
            return idx
        }

        function _decode_chars(y, x) {
            while (y.length > 0) {
                var ch = y[0];
                if (ch < 0x80) {
                    y.shift();
                    x.push(String.fromCharCode(ch))
                } else if ((ch & 0x80) == 0xc0) {
                    if (y.length < 2)break;
                    ch = y.shift();
                    var ch1 = y.shift();
                    x.push(String.fromCharCode(((ch & 0x1f) << 6) + (ch1 & 0x3f)))
                } else {
                    if (y.length < 3)break;
                    ch = y.shift();
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    x.push(String.fromCharCode(((ch & 0x0f) << 12) + ((ch1 & 0x3f) << 6) + (ch2 & 0x3f)))
                }
            }
        }

        function _decode(s) {
            var pads = 0, i, b10, imax = s.length, x = [], y = [];
            s = String(s);
            if (imax === 0) {
                return s
            }
            if (imax % 4 !== 0) {
                throw"Cannot decode base64"
            }
            if (s.charAt(imax - 1) === _PADCHAR) {
                pads = 1;
                if (s.charAt(imax - 2) === _PADCHAR) {
                    pads = 2
                }
                imax -= 4
            }
            for (i = 0; i < imax; i += 4) {
                var ch1 = _getbyte64(s, i);
                var ch2 = _getbyte64(s, i + 1);
                var ch3 = _getbyte64(s, i + 2);
                var ch4 = _getbyte64(s, i + 3);
                b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6) | _getbyte64(s, i + 3);
                y.push(b10 >> 16);
                y.push((b10 >> 8) & 0xff);
                y.push(b10 & 0xff);
                _decode_chars(y, x)
            }
            switch (pads) {
                case 1:
                    b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6);
                    y.push(b10 >> 16);
                    y.push((b10 >> 8) & 0xff);
                    break;
                case 2:
                    b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12);
                    y.push(b10 >> 16);
                    break
            }
            _decode_chars(y, x);
            if (y.length > 0)throw"Cannot decode base64";
            return x.join("")
        }

        function _get_chars(ch, y) {
            if (ch < 0x80)y.push(ch); else if (ch < 0x800) {
                y.push(0xc0 + ((ch >> 6) & 0x1f));
                y.push(0x80 + (ch & 0x3f))
            } else {
                y.push(0xe0 + ((ch >> 12) & 0xf));
                y.push(0x80 + ((ch >> 6) & 0x3f));
                y.push(0x80 + (ch & 0x3f))
            }
        }

        function _encode(s) {
            if (arguments.length !== 1) {
                throw"SyntaxError: exactly one argument required"
            }
            s = String(s);
            if (s.length === 0) {
                return s
            }
            var i, b10, y = [], x = [], len = s.length;
            i = 0;
            while (i < len) {
                _get_chars(s.charCodeAt(i), y);
                while (y.length >= 3) {
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    var ch3 = y.shift();
                    b10 = (ch1 << 16) | (ch2 << 8) | ch3;
                    x.push(_ALPHA.charAt(b10 >> 18));
                    x.push(_ALPHA.charAt((b10 >> 12) & 0x3F));
                    x.push(_ALPHA.charAt((b10 >> 6) & 0x3f));
                    x.push(_ALPHA.charAt(b10 & 0x3f))
                }
                i++
            }
            switch (y.length) {
                case 1:
                    var ch = y.shift();
                    b10 = ch << 16;
                    x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _PADCHAR + _PADCHAR);
                    break;
                case 2:
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    b10 = (ch1 << 16) | (ch2 << 8);
                    x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _ALPHA.charAt((b10 >> 6) & 0x3f) + _PADCHAR);
                    break
            }
            return x.join("")
        }

        return {decode: _decode, encode: _encode, VERSION: _VERSION}
    }(jQuery));

    modal.init = function (params) {
        window.tpl = params.tpl;
        modal.is_xcx = params.is_xcx;
        modal.attachurl = params.attachurl;
        modal.type = params.type;
        modal.data = params.data;
        modal.id = params.id;
        modal.diymenu = params.diymenu;
        modal.diyadvs = params.diyadvs;
        modal.levels = params.levels;
        modal.merch = params.merch;
        modal.plugins = params.plugins ? params.plugins : {};
        modal.shopset = params.shopset;
        if (modal.data != 'null') {
            modal.type = modal.data.page.type;
            modal.page = modal.data.page;
            modal.items = modal.data.items
        };
        modal.initTpl();
        modal.initPage();
        modal.initItems();
        modal.initNavs();
        modal.initSortable();
        modal.initGotop();
        $(".btn-save").unbind('click').click(function () {
            var status = $(this).data('status');
            var type = $(this).data('type');
            if (status) {
                tip.msgbox.err("正在保存，请稍候。。。");
                return
            }
            if (type == 'preview') {
                modal.save(true)
            } else if (type == 'save') {
                modal.save()
            } else if (type = 'savetemp') {
                modal.initTemp();
                return
            }
        });
        $("#page").unbind('click').click(function () {
            if (modal.selected == 'page') {
                return
            };
            modal.selected = 'page';
            modal.initPage()
        });
        var preview_id = util.cookie.get('preview_id');
        if (preview_id) {
            setTimeout(function () {

                var previewUrl = biz.url("diypage/page/preview") + "&id=" + preview_id;
                window.open(previewUrl)
            }, 1000);
            util.cookie.set('preview_id', '')
        }
    };
    modal.initNavs = function () {
        modal.getNavs();
        //, 'seckill_times', 'seckill_rooms', 'seckill_advs', 'seckill_list'//秒杀相关
        var navgroup = {
            0: ['listmenu', 'richtext','notice','goods', 'title', 'line', 'blank', 'menu', 'picture', 'banner', 'picturew', 'pictures', 'video','videos','copyright'],
        };
        if (sys_model_shop_fightgroup == 1){
            navgroup[0].push('fightgroup');
        }
        var navpage = navgroup[modal.type];
        if (navpage) {
            navpage = $.merge(navpage, navgroup[0])
        } else {
            navpage = navgroup[0]
        }
        $.each(navpage, function (index, val) {
            var params = modal.navs[val];
            if (params) {
                params.id = val;
                /* if (val == 'merchgroup' && (!modal.plugins.merch || modal.merch)) {
                 return true
                 }
                 if (val == 'seckillgroup' && (!modal.plugins.seckill || modal.seckill)) {
                 return true
                 }
                 if (val == 'detail_seckill' && (!modal.plugins.seckill || modal.seckill)) {
                 return true
                 }

                 if (modal.is_xcx == 1){
                 if (val == 'richtext' || val == 'listmenu' || val == 'icongroup' || val == 'tabbar' || val == 'blank' || val == 'menu2' || val =='audio'){
                 return true;
                 }
                 }*/
                //console.log(params);
                modal.initnav.push(params)
            }
        });
        var html = tpl("tpl_navs", modal);
        $("#navs").html(html).show();
        $("#navs nav").unbind('click').click(function () {
            var id = $(this).data('id');
            if (id === 'page') {
                $("#page").trigger("click");
                return
            }
            if (id == 'merchgroup' && !modal.plugins.merch) {
                tip.msgbox.err("禁止添加此元素！");
                return
            }
            if ((id == 'seckillgroup' || id == 'detail_seckill') && !modal.plugins.seckill) {
                tip.msgbox.err("禁止添加此元素！");
                return
            }
            var inArray = $.inArray(id, navpage);
            if (inArray < 0) {
                tip.msgbox.err("此页面类型禁止添加此元素！");
                return
            }
            var item = $.extend(true, {}, modal.navs[id]);
            delete item.name;
            if (!item) {
                tip.msgbox.err("未找到此元素！");
                return
            }
            var itemTplShow = $("#tpl_show_" + id).length;
            var itemTplEdit = $("#tpl_edit_" + id).length;
            if (itemTplShow == 0 || itemTplEdit == 0) {
                tip.msgbox.err("添加失败！模板错误，请刷新页面重试");
                return
            }

            var itemid = modal.getId("M", 0);
            if (item.data) {
                var itemData = $.extend(true, {}, item.data);
                var newData = {};
                var index = 0;
                $.each(itemData, function (id, data) {
                    var childid = modal.getId("C", index);
                    newData[childid] = data;
                    delete childid;
                    index++
                });
                item.data = newData
            }
            if (item.max && item.max > 0) {
                var itemNum = modal.getItemNum(id);
                if (itemNum > 0 && itemNum >= item.max) {
                    tip.msgbox.err("此元素最多允许添加 " + item.max + " 个");
                    return
                }
            }
            var append = true;
            if (modal.selected && modal.selected != 'page') {
                var thisitem = modal.items[modal.selected];
                if (thisitem.id == 'detail_navbar' || thisitem.id == 'detail_pullup' || id == 'detail_navbar' || id == 'detail_pullup') {
                    append = false
                }
            }
            if (item.istop) {
                var newItems = {};
                newItems[itemid] = item;
                $.each(modal.items, function (id, eachitem) {
                    newItems[id] = eachitem
                });
                modal.items = newItems
            } else if (modal.selected && modal.selected != 'page' && append) {
                var newItems = {};
                $.each(modal.items, function (id, eachitem) {
                    newItems[id] = eachitem;
                    if (id == modal.selected) {
                        newItems[itemid] = item
                    }
                });
                modal.items = newItems
            } else {
                if (modal.page.type == 5 && modal.items && id != 'detail_navbar') {
                    var navbar = null;
                    var pullup = null;
                    $.each(modal.items, function (newitemid, newitem) {
                        if (newitem.id == 'detail_navbar') {
                            navbar = {itemid: newitemid, item: newitem};
                            delete modal.items[newitemid]
                        } else if (newitem.id == 'detail_pullup') {
                            pullup = {itemid: newitemid, item: newitem};
                            delete modal.items[newitemid]
                        }
                    });
                    modal.items[itemid] = item;
                    if (pullup) {
                        modal.items[pullup.itemid] = pullup.item
                    }
                    if (navbar) {
                        modal.items[navbar.itemid] = navbar.item
                    }
                } else {
                    modal.items[itemid] = item
                }
            };
            modal.initItems();
            $(".drag[data-itemid='" + itemid + "']").trigger('mousedown').trigger('click');
            modal.selected = itemid
        })
    };
    modal.getId = function (S, N) {
        var date = +new Date();
        var id = S + (date + N);
        return id
    };
    modal.getNavs = function () {
        modal.navs = {
            notice: {
                name: '公告',
                params: {
                    'iconurl': '/a_static/customize/images/default/hotdot.png',
                    'noticedata': '0',
                    'speed': '4',
                    'noticenum': '5'
                },
                style: {
                    'background': '#ffffff',
                    'iconcolor': '#fd5454',
                    'color': '#666666',
                    'bordercolor': '#e2e2e2'
                },
                data: {
                    C0123456789101: {title: '这里是第一条自定义公告的标题', linkurl: '',},
                    C0123456789102: {title: '这里是第二条自定义公告的标题', linkurl: '',}
                }
            },
            banner: {
                name: '图片轮播',
                params: {},
                style: {
                    'height': '125',
                    'paddingtop':0,
                    'dotstyle': 'round',
                    'indicatorPos': 'bottomCenter',
                    'background': '#ffffff',
                    'showtitle': 1,
                    'interval': 5,
                    'effect3d':1,
                },
                data: {
                    C0123456789101: {
                        imgurl: '/a_static/customize/images/default/banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: '/a_static/customize/images/default/banner-2.jpg',
                        linkurl: '',
                    }
                }
            },
            richtext: {name: '富文本', params: {content: ''}, style: {'background': '#ffffff', 'padding': '0'}},
            title: {
                name: '标题栏',
                params: {'title': '', 'icon': ''},
                style: {
                    'background': '#ffffff',
                    'color': '#666666',
                    'textalign': 'left',
                    'fontsize': '12',
                    'paddingtop': '5',
                    'paddingleft': '5'
                }
            },
            search: {
                name: '搜索框',
                params: {'placeholder': '请输入关键字进行搜索'},
                style: {
                    'inputbackground': '#ffffff',
                    'background': '#f1f1f2',
                    'iconcolor': '#b4b4b4',
                    'color': '#999999',
                    'paddingtop': '10',
                    'paddingleft': '10',
                    'textalign': 'left',
                    'searchstyle': ''
                }
            },
            line: {
                name: '辅助线',
                params: {},
                style: {
                    'height': '2',
                    'background': '#ffffff',
                    "border": "#000000",
                    'padding': '10',
                    'linestyle': 'solid'
                }
            },
            blank: {name: '辅助空白', params: {}, style: {height: '20', background: '#ffffff'}},
            menu: {
                name: '按钮组',
                params: {},
                style: {
                    'navstyle': '',
                    'background': '#ffffff',
                    'rownum': '4',
                    'showtype': '0',
                    'pagenum': '8',
                    'showdot': '1',
                },
                data: {
                    C0123456789101: {
                        imgurl: '/a_static/customize/images/default/icon-1.png',
                        linkurl: '',
                        text: '按钮文字1',
                        color: '#666666'
                    },
                    C0123456789102: {
                        imgurl: '/a_static/customize/images/default/icon-2.png',
                        linkurl: '',
                        text: '按钮文字2',
                        color: '#666666'
                    },
                    C0123456789103: {
                        imgurl: '/a_static/customize/images/default/icon-3.png',
                        linkurl: '',
                        text: '按钮文字3',
                        color: '#666666'
                    },
                    C0123456789104: {
                        imgurl: '/a_static/customize/images/default/icon-4.png',
                        linkurl: '',
                        text: '按钮文字4',
                        color: '#666666'
                    }
                }
            },

            picture: {
                name: '单图组',
                params: {},
                style: {'paddingtop': '0', 'paddingleft': '0'},
                data: {
                    C0123456789101: {
                        imgurl: '/a_static/customize/images/default/banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: '/a_static/customize/images/default/banner-2.jpg',
                        linkurl: '',
                    }
                }
            },
            picturew: {
                name: '图片橱窗',
                params: {row: '4', showtype: 0, pagenum: '2'},
                style: {paddingtop: '0', paddingleft: '0', showdot: 0, showbtn: 0, background: '',height:'160'},
                data: {
                    C0123456789101: {
                        imgurl: '/a_static/customize/images/default/cube-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: '/a_static/customize/images/default/cube-2.jpg',
                        linkurl: '',
                    },
                    C0123456789103: {
                        imgurl: '/a_static/customize/images/default/cube-3.jpg',
                        linkurl: '',
                    },
                    C0123456789104: {
                        imgurl: '/a_static/customize/images/default/cube-4.jpg',
                        linkurl: '',
                    }
                }
            },
            pictures: {
                name: '图片展播',
                params: {hidetext: 0, showtype: 0, rownum: 3, showbtn: 0},
                style: {
                    background: "#ffffff",
                    paddingtop: "3",
                    paddingleft: "5",
                    titlealign: 'left',
                    textalign: 'left',
                    titlecolor: '#ffffff',
                    textcolor: '#666666'
                },
                data: {
                    C0123456789101: {
                        imgurl: '/a_static/customize/images/default/goods-1.jpg',
                        linkurl: '',
                        title: '这里是上标题',
                        text: '这里是下标题'
                    },
                    C0123456789102: {
                        imgurl: '/a_static/customize/images/default/goods-2.jpg',
                        linkurl: '',
                        title: '这里是上标题',
                        text: '这里是下标题'
                    },
                    C0123456789103: {
                        imgurl: '/a_static/customize/images/default/goods-4.jpg',
                        linkurl: '',
                        title: '这里是上标题',
                        text: '这里是下标题'
                    }
                }
            },
            goods: {
                name: '商品组',
                params: {
                    'goodstype': '0',
                    'showtitle': '1',
                    'showprice': '1',
                    'showtag': '0',
                    'goodsdata': '0',
                    'cateid': '',
                    'catename': '',
                    'groupid': '',
                    'groupname': '',
                    'goodssort': '0',
                    'goodsnum': '6',
                    'showicon': '1',
                    'iconposition': 'left top',
                    'productprice': '1',
                    'showproductprice': '0',
                    'showsales': '0',
                    'productpricetext': '原价',
                    'salestext': '销量',
                    'productpriceline': '0',
                    'saleout': '-1'
                },
                style: {
                    'background': '#f3f3f3',
                    'liststyle': 'block',
                    'buystyle': 'buybtn-1',
                    'goodsicon': 'recommand',
                    'iconstyle': 'triangle',
                    'pricecolor': '#ff5555',
                    'productpricecolor': '#666666',
                    'iconpaddingtop': '0',
                    'iconpaddingleft': '0',
                    'buybtncolor': '#ff5555',
                    'iconzoom': '100',
                    'titlecolor': '#000000',
                    'tagbackground': '#fe5455',
                    'productpricecolor': '#999999',
                    'salescolor': '#999999',
                    'buyrolecolor':'#c65c82',
                    'buyrolebgcolor':'#f8ecf0'
                },
                data: {
                    C0123456789101: {
                        thumb: '/a_static/customize/images/default/goods-1.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        title: '这里是商品标题',
                        sales: '0',
                        gid: '',
                        bargain: 0,
                        credit: 0,
                        ctype: 0
                    },
                    C0123456789102: {
                        thumb: '/a_static/customize/images/default/goods-2.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        title: '这里是商品标题',
                        sales: '0',
                        gid: '',
                        bargain: 0,
                        credit: 0,
                        ctype: 0
                    },
                    C0123456789103: {
                        thumb: '/a_static/customize/images/default/goods-3.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        sales: '0',
                        title: '这里是商品标题',
                        gid: '',
                        bargain: 0,
                        credit: 0,
                        ctype: 0
                    },
                    C0123456789104: {
                        thumb: '/a_static/customize/images/default/goods-4.jpg',
                        price: '20.00',
                        productprice: '99.00',
                        sales: '0',
                        title: '这里是商品标题',
                        gid: '',
                        bargain: 0,
                        credit: 0,
                        ctype: 0
                    }
                }
            },

            listmenu: {
                name: '列表导航',
                params: {},
                style: {
                    'margintop': '10',
                    'background': '#ffffff',
                    'iconcolor': '#999999',
                    'textcolor': '#000000',
                    'remarkcolor': '#888888'
                },
                data: {
                    C0123456789101: {text: '文字1', linkurl: '', iconclass: 'icon-home', remark: '查看', dotnum: ''},
                    C0123456789102: {text: '文字2', linkurl: '', iconclass: 'icon-home', remark: '查看', dotnum: ''},
                    C0123456789103: {text: '文字3', linkurl: '', iconclass: 'icon-home', remark: '查看', dotnum: ''}
                }
            },
            video: {
                name: '单视频',
                style: {
                    ratio: 0,
                    paddingtop:0,
                },
                params: {
                    videourl: '',
                    poster: ''
                }
            },
            videos: {
                name: '视频轮播',
                style: {
                    ratio: 0,
                    paddingtop:0,
                },
                params: {

                },
                data: {
                    C0123456789101: {videourl: '', poster: ''},
                    C0123456789102: {videourl: '', poster: ''},
                }
            },
            copyright: {
                name: '版权',
                isbottom: 1,
                max: 1,
                style: {
                    showtype: 0
                },
                params: {
                    showimg: '1',
                    copyright: '请填写版权说明',
                    imgurl: '/a_static/customize/images/default/copyright.png'
                }
            },
            fightgroup: {
                name: '拼团',
                style: {
                    paddingtop:5
                },
                params: {
                    istitle:1,
                    title:'拼团列表',
                    shownum:2,
                },
                data:{
                    0:{key:1,index:1},
                    1:{key:2,index:2},
                    2:{key:3,index:1},
                    3:{key:4,index:2},
                    4:{key:5,index:1},
                    5:{key:6,index:2},
                    6:{key:7,index:1},
                    7:{key:8,index:2},
                    8:{key:9,index:1},
                    9:{key:10,index:2},
                }
         },
        seckillgroup: {
            max: 1,
                name: "秒杀组",
                params: {
                iconurl: '/a_static/customize/images/default/seckill.png',
                    hideborder: 0,
                    tag: ''
            },
            style: {
                margintop: '10',
                    background: '#ffffff',
                    titlecolor: '#444444',
                    timecolor: '#444444',
                    timesigncolor: '#444444',
                    timebgcolor: '#ffffff',
                    timebordercolor: '#d9d9d9',
                    morecolor: '#888888',
                    marketpricecolor: '#ef4f4f',
                    productpricecolor: '#999999',
            }
        },
        seckill_times: {
            type: 7,
                max: 1,
                name: "秒杀时间段",
                params: {},
            style: {
                margintop: '0',
                    background: '#ffffff',
                    color: '#333333',
                    bgcolor: '#ffffff',
                    selectedcolor: '#ff3300',
                    selectedbgcolor: '#ffffff'
            }
        },
        seckill_rooms: {
            type: 7,
                name: "秒杀会场",
                max: 1,
                params: {},
            style: {
                margintop: '0',
                    background: '#ffffff',
                    color: '#333333',
                    bgcolor: '#ffffff',
                    selectedcolor: '#ef4f4f',
                    selectedbgcolor: '#ffffff'
            }
        },
        seckill_advs: {
            type: 7,
                max: 1,
                name: "秒杀广告",
                params: {},
            style: {margintop: '0', marginbottom: '0', background: '#ffffff'}
        },
        seckill_list: {
            type: 7,
                name: "秒杀商品",
                max: 1,
                params: {
                titletext: '先下单先得哦~',
                    titleovertext: '还可以继续抢购哦~',
                    titlewaittext: '即将开始 先下单先得哦',
                    btntext: '抢购中',
                    btnovertext: '已抢完',
                    btnwaittext: '等待抢购'
            },
            style: {
                margintop: '0',
                    marginbottom: '0',
                    background: '#ffffff',
                    topbgcolor: '#f0f2f5',
                    topcolor: '#333333',
                    timebgcolor: '#464553',
                    timecolor: '#ffffff',
                    titlecolor: '#333333',
                    pricecolor: '#ef4f4f',
                    marketpricecolor: '#949598',
                    btnbgcolor: '#ef4f4f',
                    btnoverbgcolor: '#f7f7f7',
                    btnwaitbgcolor: '#04be02',
                    btncolor: '#ffffff',
                    btnovercolor: '#333333',
                    btnwaitcolor: '#ffffff',
                    processtextcolor: '#d0d1d2',
                    processbgcolor: '#ff8f8f',
            }
        },

        fixedsearch: {
            name: '固定搜索框',
                istop: 1,
                max: 1,
                params: {
                leftnav: '1',
                    rightnav: '1',
                    rightnavclick: '0',
                    leftnavicon: 'icon-shop',
                    rightnavicon: 'icon-cart',
                    searchstyle: 'round',
                    placeholder: '输入关键字进行搜索'
            },
            style: {
                background: '#000000',
                    opacity: 0.8,
                    opacityinput: 0.8,
                    leftnavcolor: '#ffffff',
                    rightnavcolor: '#ffffff',
                    searchbackground: '#ffffff',
                    searchtextcolor: '#666666'
            }
        },

    }
    };
    modal.initTilteBg = function () {
        var RgbValue = $('#page')[0].style.backgroundColor.replace("rgb(", "").replace(")", "");
        var RgbValueArry = RgbValue.split(",");
        var grayLevel = RgbValueArry[0] * 0.299 + RgbValueArry[1] * 0.587 + RgbValueArry[2] * 0.114;
        var imgsrc = grayLevel > 192 ? 'wx-top2' : 'wx-top';
        $('#page').css('background-image', 'url("/a_static/customize/diypage/images/' + imgsrc + '.png")')
    };
    modal.initItems = function (selected) {
        var phone = $("#phone");
        if (!modal.items) {
            modal.items = {};
            return
        }
        phone.empty();
        $.each(modal.items, function (itemid, item) {
            if (typeof(item.id) !== 'undefined') {
                var newItem = $.extend(true, {}, item);
                newItem.itemid = itemid;
                if (item.id == 'audio') {
                    newItem.shoplogo = modal.shopset ? modal.shopset.logo : ''
                }
                var html = tpl("tpl_show_" + item.id, newItem);
                $("#phone").append(html)
            }
        });
        var btnhtml = $("#edit-del").html();
        $("#phone .drag").append(btnhtml);
        $("#phone .drag .btn-edit-del .btn-del").unbind('click').click(function (e) {
            e.stopPropagation();
            var drag = $(this).closest(".drag");
            var itemid = drag.data('itemid');
            var nodelete = $(this).closest(".drag").hasClass("nodelete");
            if (nodelete) {
                tip.alert("此元素禁止删除");
                return
            }
            tip.confirm("确定删除吗", function () {
                var nearid = modal.getNear(itemid);
                delete modal.items[itemid];
                modal.initItems();
                if (nearid) {
                    $(document).find(".drag[data-itemid='" + nearid + "']").trigger('mousedown')
                } else {
                    $("#page").trigger('click')
                }
            })
        });
        if (selected) {
            modal.selectedItem(selected)
        }
    };
    modal.selectedItem = function (itemid) {
        if (!itemid) {
            return
        }
        modal.selected = itemid;
        if (itemid == 'page') {
            $("#page").trigger('click')
        } else {
            $(".drag[data-itemid='" + itemid + "']").addClass('selected')
        }
    };
    modal.initPage = function (initE) {
        if (typeof(initE) === 'undefined') {
            initE = true
        }
        if (!modal.page) {
            modal.page = {
                isindex: '0',
                topdiystyle: '0',
                type: modal.type,
                title: '请输入页面标题',
                name: '未命名页面',
                desc: '',
                icon: '',
                keyword: '',
                background: '#f3f3f3',
                diymenu: '0',
                diylayer: '0',
                diygotop: '0',
                followbar: '0',
                visit: '0',
                visitlevel: {member: null, commission: null},
                novisit: {title: null, link: null},
                titlebarbg: '#ffffff',
                titlebarcolor: '#000000'
            };
            if (modal.type == 5) {
                modal.page.title = "商品详情"
            }
            else if (modal.type == 8) {
                modal.page.title = "兑换中心"
            }
            else if (modal.type == 99) {
                modal.page.type = 99;
                modal.page.title = '公用模块';
                modal.page.name = '未命名模块'
            }
        }
        if(!modal.page.visitlevel){
            modal.page.visitlevel = {member: null, commission: null};
        }
        if(!modal.page.novisit){
            modal.page.novisit = {};
        }
        $("#page").text(modal.page.title);
        $("#page").css({'background-color': modal.page.titlebarbg,'color':modal.page.titlebarcolor});
        $("#phone").css({'background-color': modal.page.background});
        $("#phone").find(".drag").removeClass("selected");
        if (initE) {
            modal.initEditor()
        }
        if (modal.is_xcx == 1){
            modal.initTilteBg();
        }
    };
    modal.initSortable = function () {
        $("#phone").sortable({
            opacity: 0.8,
            placeholder: "highlight",
            items: '.drag:not(.fixed)',
            revert: 100,
            scroll: false,
            start: function (event, ui) {
                var height = ui.item.height();
                $(".highlight").css({"height": height + "px"});
                $(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');
                $(".highlight div").css({"line-height": height - 4 + "px"})
            },
            stop: function (event, ui) {
                modal.initEditor()
            },
            update: function (event, ui) {
                modal.sortItems()
            }
        });
        $("#phone").disableSelection();
        $(document).on('mousedown', "#phone .drag", function () {
            if ($(this).hasClass("selected")) {
                return
            }
            modal.selected = $(this).data('itemid');
            $("#phone").find(".drag").removeClass("selected");
            $(this).addClass("selected");
            modal.selected = $(this).data('itemid');
            modal.initEditor()
        })
    };
    modal.sortItems = function () {
        var newItems = {};
        $("#phone .drag").each(function () {
            var thisid = $(this).data('itemid');
            newItems[thisid] = modal.items[thisid]
        });
        modal.items = newItems
    };
    modal.initEditor = function (scroll) {
        if (typeof(scroll) === 'undefined') {
            scroll = true
        }
        var itemid = modal.selected;
        var top = 180;
        if (modal.selected != 'page') {
            var stop = $(".selected").position().top;
            top = stop ? stop : 0
        }
        if (scroll) {
            $("#diy-editor").unbind('animate').animate({"margin-top": top - 130 + "px"});
            //setTimeout(function () {
            //   $("body").unbind('animate').animate({scrollTop: top - 130 + "px"}, 1000)
            //}, 1000)
        }
        if (modal.selected) {
            if (modal.selected == 'page') {
                if (modal.type == 99) {
                    var html = tpl("tpl_edit_page_mod", modal.page)
                } else {
                    var html = tpl("tpl_edit_page", modal)
                }
                $("#diy-editor .inner").html(html)
            } else {
                var item = $.extend(true, {}, modal.items[modal.selected]);
                item.itemid = modal.selected;
                item.merch = modal.merch;
                item.plugins = modal.plugins;
                item.is_xcx = modal.is_xcx;
                var html = tpl("tpl_edit_" + item.id, item);
                $("#diy-editor .inner").html(html)
            }
            $("#diy-editor").attr("data-editid", modal.selected).show()
        }
        var sliderlength = $("#diy-editor .slider").length;
        if (sliderlength > 0) {
            $("#diy-editor .slider").each(function () {
                var decimal = $(this).data('decimal');
                var multiply = $(this).data('multiply');
                var defaultValue = $(this).data("value");
                if (decimal) {
                    defaultValue = defaultValue * decimal
                }
                $(this).slider({
                    slide: function (event, ui) {
                        var sliderValue = ui.value;
                        if (decimal) {
                            sliderValue = sliderValue / decimal
                        }
                        $(this).siblings(".input").val(sliderValue).trigger("propertychange");
                        $(this).siblings(".count").find("span").text(sliderValue)
                    }, value: defaultValue, min: $(this).data("min"), max: $(this).data("max")
                })
            })
        }
        var goodsSelector = $("#diy-editor .goods-selector").length;
        if (goodsSelector > 0) {
            var _this = $("#diy-editor .goods-selector");
            var url = diyUrlJ+'/_fun/query/type/good';
            if (_this.data('goodstype') == 1){
                url = diyUrlJ+'/_fun/query/type/integralgood';
            }
            _this.attr({'id': 'goods_selector', 'data-url': url, 'data-callback': 'callbackGoods'});
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'goods',autosearch:1});
                modal.childid = $(this).closest('.item').data('id')
            })
        }
        var categorySelector = $("#diy-editor .category-selector").length;
        if (categorySelector > 0) {
            var _this = $("#diy-editor .category-selector");
            var url = diyUrlJ+'/_fun/query/type/category';
            _this.attr({'id': 'category_selector', 'data-url': url, 'data-callback': 'callbackCategory'});
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'category',iq_auto: true})
            })
        }
        var groupSelector = $("#diy-editor .group-selector").length;
        if (groupSelector > 0) {
            var _this = $("#diy-editor .group-selector");
            _this.attr({
                'id': 'group_selector',
                'data-url': biz.url('goods/group/query', null, modal.merch),
                'data-callback': 'callbackGroup'
            });
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'group'})
            })
        }
        var merchSelector = $("#diy-editor .merch-selector").length;
        if (merchSelector) {
            var _this = $("#diy-editor .merch-selector");
            var url = biz.url('merch/user/query', null, modal.merch);
            _this.attr({'id': 'merch_selector', 'data-url': url, 'data-callback': 'callbackMerch'});
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'merch'});
                modal.childid = $(this).closest('.item').data('id')
            })
        }
        var merchCategorySelector = $("#diy-editor .merch-category-selector").length;
        if (merchCategorySelector) {
            var _this = $("#diy-editor .merch-category-selector");
            var url = biz.url('merch/category/query', null, modal.merch);
            _this.attr({'id': 'category_selector', 'data-url': url, 'data-callback': 'callbackMerchCategory'});
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'category'})
            })
        }
        var merchGroupSelector = $("#diy-editor .merch-group-selector").length;
        if (merchGroupSelector) {
            var _this = $("#diy-editor .merch-group-selector");
            _this.attr({
                'id': 'group_selector',
                'data-url': biz.url('merch/group/query', null, modal.merch),
                'data-callback': 'callbackMerchGroup'
            });
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'group'})
            })
        }
        var couponSelector = $("#diy-editor .coupon-selector").length;
        if (couponSelector) {
            var _this = $("#diy-editor .coupon-selector");
            _this.attr({
                'id': 'coupon_selector',
                'data-url':  diyUrlJ+'/_fun/query/type/coupon',//iqgmy biz.url('sale/coupon/query', {diy: 1}, modal.merch),
                'data-callback': 'callbackCoupon'
            });
            _this.unbind('click').click(function () {
                biz.selector.select({name: 'coupon',iq_auto: true});
                modal.childid = $(this).closest('.item').data('id')
            })
        }
        var audioPlayer = $("#diy-editor .audio-player").length;
        if (audioPlayer) {
            $("#diy-editor .audio-player").click(function () {
                var _this = $(this);
                var audio = _this.next('audio')[0];
                var src = _this.next('audio').attr('src');
                if (audio && src) {
                    if (audio.paused) {
                        audio.play();
                        _this.find('.fa').removeClass("fa-play").addClass("fa-stop");
                        var timer = setInterval(function () {
                            if (audio.currentTime >= audio.duration) {
                                audio.pause();
                                _this.find('.fa').removeClass("fa-stop").addClass("fa-play");
                                clearInterval(timer)
                            }
                        }, 1000)
                    } else {
                        audio.currentTime = 0;
                        audio.pause();
                        _this.find('.fa').removeClass("fa-stop").addClass("fa-play")
                    }
                } else {
                    tip.msgbox.err("请先选择音频！")
                }
            })
        }
        var childitems = $("#diy-editor .form-items").length;
        if (childitems > 0) {
            modal.initSortableChild();
            $("#addChild").unbind('click').click(function () {
                var itemid = modal.selected;
                var type = modal.items[itemid].id;
                var temp = modal.navs[type].data;
                var max = $(this).closest(".form-items").data('max');
                if (max) {
                    var length = modal.length(modal.items[itemid].data);
                    if (length >= max) {
                        tip.msgbox.err("最大添加 " + max + " 个！");
                        return
                    }
                }
                var newChild = {};
                var index = 0;
                $.each(temp, function (i, t) {
                    if (index == 0) {
                        newChild = t;
                        index++
                    }
                });
                if (newChild) {
                    var childName = modal.getId("M", 0);
                    if (typeof(modal.items[itemid].data) === 'undefined') {
                        modal.items[itemid].data = {}
                    }
                    newChild = $.extend(true, {}, newChild);
                    modal.items[itemid].data[childName] = newChild
                }
                modal.initItems(itemid);
                modal.initEditor(false)
            });
            $("#diy-editor .form-items .item .btn-del").unbind('click').click(function () {
                var childid = $(this).closest(".item").data('id');
                var itemid = modal.selected;
                var min = $(this).closest(".form-items").data("min");
                if (min) {
                    var length = modal.length(modal.items[itemid].data);
                    if (length <= min) {
                        tip.msgbox.err("至少保留 " + min + " 个！");
                        return
                    }
                }
                tip.confirm("确定删除吗", function () {
                    delete modal.items[itemid].data[childid];
                    modal.initItems(itemid);
                    modal.initEditor(false)
                })
            })
        }
        var richtext = $("#diy-editor .form-richtext").length;
        if (richtext > 0) {
            var ueditoroption = {
                'autoClearinitialContent': false,
                'toolbars': [[ 'source', '|','undo', 'redo','|', 'bold', 'italic', 'underline', 'strikethrough', 'forecolor', 'backcolor', '|', 'justifyleft', 'justifycenter', 'justifyright', '|', 'insertorderedlist', 'insertunorderedlist',  'emotion', 'removeformat', '|', 'rowspacingtop', 'rowspacingbottom', 'lineheight', 'indent', 'paragraph', 'fontsize', '|', 'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|', 'link']],
                'elementPathEnabled': false,
                'initialFrameHeight': 300,
                'focus': false,
                'maximumWords': 9999999
            };
            var opts = {
                type: 'image',
                direct: false,
                multiple: true,
                tabs: {'upload': 'active', 'browser': '', 'crawler': ''},
                path: '',
                dest_dir: '',
                global: false,
                thumb: false,
                width: 0
            };
            UE.registerUI('myinsertimage', function (editor, uiName) {
                editor.registerCommand(uiName, {
                    execCommand: function () {
                        require(['fileUploader'], function (uploader) {
                            uploader.show(function (imgs) {
                                if (imgs.length == 0) {
                                    return
                                } else if (imgs.length == 1) {
                                    editor.execCommand('insertimage', {
                                        'src': imgs[0]['url'],
                                        '_src': imgs[0]['url'],
                                        'width': '100%',
                                        'alt': imgs[0].filename
                                    })
                                } else {
                                    var imglist = [];
                                    for (i in imgs) {
                                        imglist.push({
                                            'src': imgs[i]['url'],
                                            '_src': imgs[i]['url'],
                                            'width': '100%',
                                            'alt': imgs[i].filename
                                        })
                                    }
                                    editor.execCommand('insertimage', imglist)
                                }
                            }, opts)
                        })
                    }
                });
                var btn = new UE.ui.Button({
                    name: '插入图片',
                    title: '插入图片',
                    cssRules: 'background-position: -726px -77px',
                    onclick: function () {
                        editor.execCommand(uiName)
                    }
                });
                editor.addListener('selectionchange', function () {
                    var state = editor.queryCommandState(uiName);
                    if (state == -1) {
                        btn.setDisabled(true);
                        btn.setChecked(false)
                    } else {
                        btn.setDisabled(false);
                        btn.setChecked(state)
                    }
                });
                return btn
            }, 48);
            UE.registerUI('myinsertvideo', function (editor, uiName) {
                editor.registerCommand(uiName, {
                    execCommand: function () {
                        require(['fileUploader'], function (uploader) {
                            uploader.show(function (video) {
                                if (!video) {
                                    return
                                } else {
                                    var videoType = video.isRemote ? 'iframe' : 'video';
                                    editor.execCommand('insertvideo', {
                                        'url': video.url,
                                        'width': 300,
                                        'height': 200
                                    }, videoType)
                                }
                            }, {fileSizeLimit: 5120000, type: 'video', allowUploadVideo: true})
                        })
                    }
                });
                var btn = new UE.ui.Button({
                    name: '插入视频',
                    title: '插入视频',
                    cssRules: 'background-position: -320px -20px',
                    onclick: function () {
                        editor.execCommand(uiName)
                    }
                });
                editor.addListener('selectionchange', function () {
                    var state = editor.queryCommandState(uiName);
                    if (state == -1) {
                        btn.setDisabled(true);
                        btn.setChecked(false)
                    } else {
                        btn.setDisabled(false);
                        btn.setChecked(state)
                    }
                });
                return btn
            }, 20);
            UE.registerUI('mylink', function (editor, uiName) {
                var btn = new UE.ui.Button({
                    name: 'selectUrl',
                    title: '系统链接',
                    cssRules: 'background-position: -622px 80px;',
                    onclick: function () {
                        $("#" + this.id).attr({"data-toggle": "selectUrl", "data-callback": "selectUrlCallback"})
                    }
                });
                editor.addListener('selectionchange', function () {
                    var state = editor.queryCommandState(uiName);
                    if (state == -1) {
                        btn.setDisabled(true);
                        btn.setChecked(false)
                    } else {
                        btn.setDisabled(false);
                        btn.setChecked(state)
                    }
                });
                return btn
            });
            if (typeof(UE) != 'undefined') {
                UE.delEditor('rich')
            }
            var ue = UE.getEditor('rich', ueditoroption);
            ue.ready(function () {
                var thisitem = modal.items[itemid];
                var richContent = thisitem.params.content;
                richContent = $.base64.decode(richContent);
                ue.setContent(richContent);
                ue.addListener('contentChange', function () {
                    var newContent = ue.getContent();
                    newContent = $.base64.encode(newContent);
                    $("#richtext").html(newContent).trigger('change')
                })
            })
        }
        $("#diy-editor").find(".diy-bind").bind('input propertychange change', function () {
            var _this = $(this);
            var bind = _this.data("bind");
            var bindchild = _this.data('bind-child');
            var bindparent = _this.data('bind-parent');
            var initEditor = _this.data('bind-init');
            var value = '';
            var tag = this.tagName;
            if (!itemid) {
                modal.selectedItem('page ')
            }
            if (tag == 'INPUT') {
                var type = _this.attr('type');
                if (type == 'checkbox') {
                    value = [];
                    _this.closest('.form-group').find('input[type=checkbox]').each(function () {
                        var checked = this.checked;
                        var valname = $(this).val();
                        if (checked) {
                            value.push(valname)
                        }
                    })
                } else {
                    var placeholder = _this.data('placeholder');
                    value = _this.val();
                    value = value == '' ? placeholder : value
                }
            } else if (tag == 'SELECT') {
                value = _this.find('option:selected').val()
            } else if (tag == 'TEXTAREA') {
                value = _this.val()
            }
            value = $.trim(value);
            if (itemid == 'page') {
                if (bindchild) {
                    if (!modal.page[bindchild]) {
                        modal.page[bindchild] = {}
                    }
                    modal.page[bindchild][bind] = value
                } else {
                    modal.page[bind] = value
                }
                modal.initPage(false);
                if (bind == 'keyword') {
                    $.post(biz.url('diypage/page/keyword'), {id: modal.id, keyword: value}, function (r) {
                        if (r.status == 0) {
                            _this.closest('.form-group').addClass('has-error');
                            modal.keyworderr = true
                        } else {
                            _this.closest('.form-group').removeClass('has-error');
                            modal.keyworderr = false
                        }
                    }, 'json')
                }
            } else {
                if (bindchild) {
                    if (bindparent) {
                        modal.items[itemid][bindparent][bindchild][bind] = value
                    } else {
                        modal.items[itemid][bindchild][bind] = value
                    }
                } else {
                    modal.items[itemid][bind] = value
                }
                modal.initItems(itemid)
            }
            if (initEditor) {
                modal.initEditor(false)
            }
        })
    };
    modal.initSortableChild = function () {
        $("#diy-editor .inner").sortable({
            opacity: 0.8,
            placeholder: "highlight",
            items: '.item',
            revert: 100,
            scroll: false,
            cancel: '.goods-selector,input,select,.btn,btn-del',
            start: function (event, ui) {
                var height = ui.item.height();
                $(".highlight").css({"height": height + 22 + "px"});
                $(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');
                $(".highlight div").css({"line-height": height + 16 + "px"})
            },
            update: function (event, ui) {
                modal.sortChildItems()
            }
        })
    };
    modal.initMod = function (item) {
        $.ajax(biz.url('diypage/page/mod/query', null, modal.merch), {
            type: "get",
            dataType: "html",
            cache: false
        }).done(function (html) {
            modModal = $('<div class="modal fade" id="modModal"></div>');
            $(document.body).append(modal), modModal.modal('show');
            modModal.append2(html, function () {
                $(document).off("click", '#modModal nav').on("click", '#modModal nav', function () {
                    var modid = $(this).data('id');
                    var modname = $(this).data('name');
                    modModal.find(".close").click();
                    var itemid = modal.getId("M", 0);
                    item.params.modid = modid;
                    item.params.modname = modname;
                    if (modal.selected && modal.selected != 'page') {
                        var newItems = {};
                        $.each(modal.items, function (id, eachitem) {
                            newItems[id] = eachitem;
                            if (id == modal.selected) {
                                newItems[itemid] = item
                            }
                        });
                        modal.items = newItems
                    } else {
                        modal.items[itemid] = item
                    }
                    modal.initItems();
                    $(".drag[data-itemid='" + itemid + "']").trigger('mousedown').trigger('click');
                    modal.selected = itemid
                })
            })
        })
    };
    modal.initTemp = function () {
        var itemslength = 0;
        $.each(modal.items, function (index) {
            itemslength++;
            return false
        });
        if (!itemslength) {
            tip.msgbox.err("您还没有添加任何元素，不能保存为模板！");
            return
        }
        if (modal.type == 99) {
            tip.msgbox.err("页面类型为公用模块，不能保存为模板！");
            return
        }
        $("#saveTempModal").modal();
        $("#saveTemp", "#saveTempModal").unbind('click').click(function () {
            var tempname = $.trim($("#saveTempModal").find("#saveTempName").val());
            var tempcate = $.trim($("#saveTempModal").find("#saveTempCate option:selected").val());
            var temppreview = $.trim($("#saveTempModal").find("#saveTempPreview").val());
            var tempdata = {page: modal.page, items: modal.items};
            if (!tempname) {
                tip.msgbox.err("请填写模板名称！");
                $("#saveTempModal").find("#saveTempName").focus();
                return
            }
            $("#saveTempModal .close").trigger('click');
            if (modal.type == 1) {
                var posturl = biz.url("diypage/page/diy/savetemp", null, modal.merch)
            } else if (modal.type > 1 && modal.type < 6 && modal.type != 4) {
                var posturl = biz.url("diypage/page/sys/savetemp", null, modal.merch)
            } else if (modal.type > 4 && modal.type < 99 && modal.type != 5) {
                var posturl = biz.url("diypage/page/plu/savetemp", null, modal.merch)
            }
            $.post(posturl, {
                type: modal.type,
                cate: tempcate,
                name: tempname,
                preview: temppreview,
                data: tempdata
            }, function (ret) {
                if (ret.status == 0) {
                    tip.msgbox.err(ret.result.message)
                } else {
                    tip.msgbox.suc("另存为模板保存成功！")
                }
            }, 'json')
        })
    };
    modal.initTpl = function () {
        tpl.helper("imgsrc", function (src) {
            if (typeof src != 'string') {
                return ''
            }
            if (src.indexOf('http://') == 0 || src.indexOf('https://') == 0 || src.indexOf('/a_static/customize/') == 0 || src.indexOf('/upload') == 0) {
                return src
            } else if (src.indexOf('images/') == 0 || src.indexOf('audios/') == 0) {
                return modal.attachurl + src
            }
        });
        tpl.helper("decode", function (content) {
            return $.base64.decode(content)
        });
        tpl.helper("count", function (data) {
            return modal.length(data)
        });
        tpl.helper("toArray", function (data) {
            var oldArray = $.makeArray(data);
            var newArray = [];
            $.each(data, function (itemid, item) {
                newArray.push(item)
            });
            return newArray
        });
        tpl.helper("strexists", function (str, tag) {
            if (!str || !tag) {
                return false
            }
            if (str.indexOf(tag) != -1) {
                return true
            }
            return false
        });
        tpl.helper("inArray", function (str, tag) {
            if (!str || !tag) {
                return false
            }
            if(typeof(str)=='string'){
                var arr = str.split(",");
                if($.inArray(tag, arr)>-1){
                    return true;
                }
            }
            return false
        });
        tpl.helper("define", function (str) {
            var str
        })
    };
    modal.initGotop = function () {
        $(window).bind('scroll resize', function () {
            var scrolltop = $(window).scrollTop();
            if (scrolltop > 300) {
                $("#gotop").show()
            } else {
                $("#gotop").hide()
            }
            $("#gotop").unbind('click').click(function () {
                $('body').animate({scrollTop: "0px"}, 1000)
            })
        })
    };
    modal.getNear = function (itemid) {
        var newarr = [];
        var index = 0;
        var prev = 0;
        var next = 0;
        $.each(modal.items, function (id, obj) {
            newarr[index] = id;
            if (id == itemid) {
                prev = index - 1;
                next = index + 1
            }
            index++
        });
        var pervid = newarr[prev];
        var nextid = newarr[next];
        if (nextid) {
            return nextid
        }
        if (pervid) {
            return pervid
        }
        return false
    };
    modal.getItemNum = function (id) {
        if (!id || !modal.items) {
            return -1
        }
        var itemNum = 0;
        $.each(modal.items, function (itemid, eachitem) {
            if (eachitem.id == id) {
                itemNum++
            }
        });
        return itemNum
    };
    modal.sortChildItems = function () {
        var newChild = {};
        var itemid = modal.selected;
        $("#diy-editor .form-items .item").each(function () {
            var thisid = $(this).data('id');
            newChild[thisid] = modal.items[itemid].data[thisid]
        });
        modal.items[itemid].data = newChild;
        modal.initItems(itemid)
    };
    modal.length = function (json) {
        if (typeof(json) === 'undefined') {
            return 0
        }
        var jsonlen = 0;
        for (var item in json) {
            jsonlen++
        }
        return jsonlen
    };
    modal.callbackGoods = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        var childid = modal.childid;
        modal.items[itemid].data[childid] = {
            'title': data.title,
            'thumb': data.thumb,
            'price': data.price,
            'gid': data.gid,
            'productprice': data.productprice,
            'sales': data.sales,
            'bargain': data.bargain,
            'credit': data.credit
        };
        modal.initItems(itemid);
        modal.initEditor(false);
        modal.childid = null
    };
    modal.callbackCategory = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.catename = data.name;
        modal.items[itemid].params.cateid = data.id;
        modal.items[itemid].params.groupname = '';
        modal.items[itemid].params.groupid = '';
        modal.initItems(itemid);
        modal.initEditor(false)
    };
    modal.callbackGroup = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.groupname = data.name;
        modal.items[itemid].params.groupid = data.id;
        modal.items[itemid].params.catename = '';
        modal.items[itemid].params.cateid = '';
        modal.initItems(itemid);
        modal.initEditor()
    };
    modal.callbackMerch = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        var childid = modal.childid;
        modal.items[itemid].data[childid] = {
            'name': data.merchname,
            'thumb': data.logo,
            'merchid': data.id,
            'desc': data.desc
        };
        modal.initItems(itemid);
        modal.initEditor(false);
        modal.childid = null
    };
    modal.callbackMerchCategory = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.catename = data.catename;
        modal.items[itemid].params.cateid = data.id;
        modal.items[itemid].params.groupname = '';
        modal.items[itemid].params.groupid = '';
        modal.initItems(itemid);
        modal.initEditor(false)
    };
    modal.callbackMerchGroup = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.groupname = data.groupname;
        modal.items[itemid].params.groupid = data.id;
        modal.items[itemid].params.catename = '';
        modal.items[itemid].params.cateid = '';
        modal.initItems(itemid);
        modal.initEditor()
    };
    modal.callbackCoupon = function (data) {
        if (!data) {
            tip.msgbox.err("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        var childid = modal.childid;
        modal.items[itemid].data[childid].price = data.values;
        modal.items[itemid].data[childid].desc = data.uselimit;
        modal.items[itemid].data[childid].couponid = data.id;
        modal.items[itemid].data[childid].name = data.couponname;
        modal.initItems(itemid);
        modal.initEditor(false);
        modal.childid = null
    };
    modal.save = function (preview) {
        if (typeof(preview) === 'undefined') {
            preview = false
        }
        if (preview && modal.type == 5) {
            tip.msgbox.err("商品详情页涉及商品数据问题，请至手机端预览");
            return
        }
        if (modal.keyworderr) {
            tip.msgbox.err("关键字已存在！");
            $("#page").trigger('click');
            $("#diy-editor input[data-bind='keyword']").closest('.form-group').addClass('has-error');
            return
        }
        modal.data = {};
        modal.data = {page: modal.page, items: modal.items};
        if (!modal.page.name || modal.page.name == '未命名页面') {
            tip.msgbox.err("请填写页面命名.");
            $("#page").trigger("click");
            return
        }
        if (!modal.page.title || modal.page.title == '请输入页面标题') {
            tip.msgbox.err("页面标题是必填项.");
            $("#page").trigger("click");
            return
        }
        $(".btn-save").data('status', 1).text("保存中...");
        if (modal.type == 1) {
            if (modal.id > 0) {
                var posturl = biz.url("diyEdit", null, modal.merch)
            } else {
                var posturl = biz.url("diyAdd", null, modal.merch)
            }
        } else if (modal.type > 1 && modal.type < 6 && modal.type != 4) {
            if (modal.id > 0) {
                //var posturl = biz.url("diypage/page/sys/edit", null, modal.merch)
                var posturl = diyUrlJ+'/_fun/save';
            } else {
                //var posturl = biz.url("diypage/page/sys/add", null, modal.merch)
                var posturl = diyUrlJ+'/_fun/save';
            }
        } else if (modal.type > 4 && modal.type < 99 && modal.type != 5) {
            if (modal.id > 0) {
                var posturl = biz.url("diypage/page/plu/edit", null, modal.merch)
            } else {
                var posturl = biz.url("diypage/page/plu/add", null, modal.merch)
            }
        } else if (modal.type == 99) {
            if (modal.id > 0) {
                var posturl = biz.url("diypage/page/mod/edit", null, modal.merch)
            } else {
                var posturl = biz.url("diypage/page/mod/add", null, modal.merch)
            }
        }
        $.post(posturl, {id: modal.id, data: JSON.stringify(modal.data)}, function (ret) {
            if (ret.status == 0 || ret.code == 0) {
                if (ret.status == 0){
                    tip.msgbox.err(ret.result.message);
                }else{
                    tip.msgbox.err(ret.msg);
                }
                $(".btn-save[data-type='save']").text("保存页面").data("status", 0);
                $(".btn-save[data-type='preview']").text("保存并预览").data("status", 0);
                $(".btn-save[data-type='savetemp']").text("另存为模板").data("status", 0);
                return
            }
            var pageid = ret.result.id;
            if (pageid == modal.id) {
                $(".btn-save[data-type='save']").text("保存页面").data("status", 0);
                $(".btn-save[data-type='preview']").text("保存并预览").data("status", 0);
                $(".btn-save[data-type='savetemp']").text("另存为模板").data("status", 0);
                if (preview) {
                    tip.msgbox.suc("保存成功！正在生成预览...");
                    setTimeout(function () {
                        //var previewUrl = biz.url("diypage/page/preview", null, modal.merch) + "&id=" + pageid;
                        window.open(previewUrlJ +"?id=" + pageid)
                    }, 1000)
                } else {
                    tip.msgbox.suc("保存成功！")
                }
            } else {
                if (preview) {
                    tip.msgbox.suc("保存成功！正在生成预览...");
                    util.cookie.set('preview_id', pageid)
                } else {
                    tip.msgbox.suc("保存成功！")
                }
                location.href = ret.result.jump
            }
        }, 'json')
    };
    modal.length = function (json) {
        if (typeof(json) === 'undefined') {
            return 0
        }
        var jsonlen = 0;
        for (var item in json) {
            jsonlen++
        }
        return jsonlen
    };
    return modal
});